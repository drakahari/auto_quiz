<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Review Missed Questions</title>
<link rel="stylesheet" href="/style.css">

<style>
.review-container {
    max-width: 980px;
    margin: auto;
}

.info-box {
    background: rgba(0,0,0,.75);
    border: 1px solid rgba(255,255,255,.3);
    padding: 14px;
    border-radius: 8px;
    margin-bottom: 14px;
}

.missedLabel {
    color: #ff8080;
    font-weight: bold;
}
</style>
</head>

<body>

<div class="container review-container">

    <h1 class="hero-title">
        üîÅ Review Missed Questions
    </h1>

    <div id="info" class="info-box">
        Loading missed questions‚Ä¶
    </div>

    <div id="reviewArea"></div>

    <br>
    <button onclick="location.href='/'">‚¨Ö Back to Portal</button>
    <button onclick="location.href='/history.html'">üìú Back to History</button>

</div>

<script>
const HISTORY_KEY = "serverplus_history_v2";

/* =========================
   LOAD HISTORY
========================= */
function loadHistoryStore() {
    try {
        return JSON.parse(localStorage.getItem(HISTORY_KEY) || "{}");
    } catch (e) {
        console.error("History JSON corrupted, clearing", e);
        localStorage.removeItem(HISTORY_KEY);
        return {};
    }
}

/* =========================
   LOAD QUIZ JSON
========================= */
async function loadQuizData() {
    const file = (typeof QUIZ_FILE !== "undefined") ? QUIZ_FILE : "quiz.json";
    const res = await fetch(file);
    return await res.json();
}

/* =========================
   RENDER MISSED QUESTIONS
========================= */
async function renderMissedReview() {
    const info = document.getElementById("info");
    const container = document.getElementById("reviewArea");

    if (!info || !container) return;

    const store = loadHistoryStore();
    const quizKeys = Object.keys(store);

    if (!quizKeys.length) {
        info.innerHTML = "‚ùå No history found yet. Take an exam first.";
        return;
    }

    let html = "";
    let totalMissedSet = new Set();

    for (const key of quizKeys) {
        const attempts = store[key];
        if (!attempts || !attempts.length) continue;

        let missed = [];

        attempts.forEach(r => {
            if (!r.missed) return;

            r.missed.forEach(m => missed.push(m));
        });

        if (!missed.length) continue;

        info.innerHTML = `
            <b>Total Quiz Sets Tracked:</b> ${quizKeys.length}<br>
            <span class="missedLabel">Total Unique Missed Questions:</span> 
            ${new Set(missed.map(m => normalizeMissedValue(m))).size}
        `;

        html += `<h2>üìò ${key.replace("/data/","")}</h2>`;

        const quiz = await fetchQuizSafely(key);

        const uniqueMissed = [...new Set(missed.map(m => normalizeMissedValue(m)))];

        uniqueMissed.forEach(raw => {

            const missedNum = normalizeMissedValue(raw);

            if (!missedNum) {
                html += renderProblemCard("Unknown", `Unrecognized entry: ${JSON.stringify(raw)}`);
                return;
            }

            totalMissedSet.add(missedNum);

            const q = quiz.find(q => Number(q.number) === Number(missedNum));

            if (!q) {
                html += renderProblemCard(missedNum,
                    `Could not locate this question in quiz JSON.<br>
                     This usually happens if numbering changed.`);
                return;
            }

            // get choices
            let choicesHtml = "";
            q.choices.forEach((c,i)=>{
                const letter = String.fromCharCode(65+i);
                choicesHtml += `<div><b>${letter}.</b> ${extractChoiceText(c)}</div>`;
            });

            // correct answers
            const correctLetters =
                (q.correct_answers || q.correct || [])
                .map(x => typeof x === "string"
                    ? x
                    : String.fromCharCode(65 + x))
                .join(", ");

            html += `
            <div class="review-card review-wrong">
                <h3>Question ${q.number}</h3>
                <p>${q.question}</p>
                <b>Choices:</b><br>
                ${choicesHtml}
                <p><b>Correct Answer:</b> ${correctLetters}</p>
            </div>`;
        });
    }

    if (totalMissedSet.size === 0) {
        info.innerHTML = "üéâ You haven't missed anything recently! Great job!";
    }

    container.innerHTML = html;
}

/* =========================
   HELPERS
========================= */

function renderProblemCard(num, msg) {
    return `
        <div class="review-card review-wrong">
            <h3>Question ${num}</h3>
            <p>${msg}</p>
        </div>`;
}

function extractChoiceText(c) {
    if (typeof c === "string") return c;
    if (c.text) return c.text;
    if (c.answer) return c.answer;
    return JSON.stringify(c);
}

function normalizeMissedValue(raw) {
    if (typeof raw === "number") return raw;
    if (typeof raw === "string" && /^\d+$/.test(raw)) return Number(raw);
    if (typeof raw === "object" && raw !== null)
        return raw.number ?? raw.id ?? raw.q ?? raw.index ?? null;
    return null;
}

// load quiz by key
async function fetchQuizSafely(key) {
    try {
        const file = key.startsWith("/") ? key : `/data/${key}`;
        const res = await fetch(file);
        return await res.json();
    } catch {
        return [];
    }
}

/* =========================
   RUN
========================= */
renderMissedReview();
</script>

</body>
</html>
