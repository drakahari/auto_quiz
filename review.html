<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Review Missed Questions</title>
<link rel="stylesheet" href="/style.css">

<style>
.review-container { max-width: 980px; margin: auto; }
.info-box {
    background: rgba(0,0,0,.75);
    border: 1px solid rgba(255,255,255,.3);
    padding: 14px;
    border-radius: 8px;
    margin-bottom: 14px;
}
.reviewCard {
    background: rgba(0,0,0,.85);
    padding: 12px;
    margin: 12px 0;
    border-radius: 8px;
    border-left: 8px solid #ff4d4d;
}
.correctBox { color: #00ff80; margin-top: 6px; }
.userBox { color: #ff6b6b; margin-top: 6px; }
.ankiRow { display: flex; gap: 10px; margin-bottom: 8px; }
</style>
</head>

<body>

<script>
fetch("/config/portal.json")
  .then(r => r.json())
  .then(cfg => {
      if (cfg.background_image) {
          document.documentElement.style.setProperty("--portal-bg", `url(${cfg.background_image})`);
      }
  });
</script>

<div class="container review-container">

<h1 class="hero-title">üîÅ Review Missed Questions</h1>
<div id="info" class="info-box">Loading‚Ä¶</div>
<div id="reviewArea"></div>

<div style="margin-top:20px;">
    <button onclick="exportSelectedToAnki()">üß† Export Selected to Anki</button>
</div>

<br>
<button onclick="location.href='/'">‚¨Ö Back to Portal</button>
<button onclick="location.href='/history.html'">üìú Back to History</button>

</div>

<script>
async function loadReview() {
    const info = document.getElementById("info");
    const box  = document.getElementById("reviewArea");
    const attemptId = new URLSearchParams(window.location.search).get("attempt");

    if (!attemptId) {
        info.innerHTML = "‚ùå No attempt specified.";
        return;
    }

    const metaRes = await fetch("/api/attempts");
    const meta = await metaRes.json();
    const attempt = (meta.attempts || []).find(a => a.id == attemptId);

    info.innerHTML = `
        <b>Quiz:</b> ${attempt.quiz_title}<br>
        <b>Score:</b> ${attempt.score}/${attempt.total} (${attempt.percent}%)<br>
        <b>Date:</b> ${attempt.completed_at}<br>
        <b>Mode:</b> ${attempt.mode}
    `;

    const res = await fetch(`/api/missed_questions?attempt=${attemptId}`);
    const missed = await res.json();

    if (!missed.length) {
        box.innerHTML = "<p>üéâ No missed questions!</p>";
        return;
    }

    box.innerHTML = missed.map(m => `
        <div class="reviewCard">
            <div class="ankiRow">
                <input type="checkbox" class="anki-select" value="${m.id}">
                <span>Add to Anki deck</span>
            </div>

            <h3>Question ${m.question_number}</h3>
            <div>${m.question_text}</div>

            <div class="correctBox">
                <b>Correct Answer</b><br>
                ${m.correct_text || m.correct_letters}
            </div>

            <div class="userBox">
                <b>Your Answer</b><br>
                ${m.selected_text || m.selected_letters}
            </div>
        </div>
    `).join("");
}

function exportSelectedToAnki() {
    const selected = [...document.querySelectorAll(".anki-select:checked")]
        .map(cb => Number(cb.value));

    if (!selected.length) {
        alert("Select at least one question.");
        return;
    }

    fetch("/export/anki", {
        method: "POST",
        headers: {"Content-Type": "application/json"},
        body: JSON.stringify({ missed_ids: selected })
    })
    .then(res => res.blob())
    .then(blob => {
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = "autoquiz_missed_questions.apkg";
        a.click();
        URL.revokeObjectURL(url);
    });
}

loadReview();
</script>
</body>
</html>
