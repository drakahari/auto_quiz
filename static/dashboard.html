<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Analytics Dashboard</title>
<link rel="stylesheet" href="/static/style.css">
<link rel="icon" href="/static/favicon.ico">

<style>

.container {
    max-width: 960px;
    margin: auto;
}

.stat-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit,minmax(200px,1fr));
    gap: 14px;
}

.stat-card {
    background: rgba(0,0,0,.75);
    border: 1px solid rgba(255,255,255,.25);
    padding: 12px;
    border-radius: 10px;
    text-align:center;
    box-shadow: 0 0 25px rgba(0,0,0,.9);
}

.big {
    font-size: 30px;
    font-weight: bold;
}

.good { color:#00ff80; }
.warn { color:#ffeb3b; }
.bad  { color:#ff5050; }

.section {
    margin-top:18px;
    padding:12px;
    border-radius:10px;
    background:rgba(0,0,0,.65);
    border:1px solid rgba(255,255,255,.25);
}

</style>
</head>

<body>
<div class="container">

<!-- <script>
fetch("/config/portal.json")
  .then(r => r.json())
  .then(cfg => {
      if (cfg.background_image) {
          document.documentElement.style.setProperty(
              "--portal-bg",
              `url(${cfg.background_image})`
          );
      }
  });
</script> -->

<h1 class="hero-title">
üìä Performance & Study Analytics
</h1>

<div id="analytics"></div>

<br>
<button onclick="location.href='/'">üè† Back to Portal</button>
<button onclick="location.href='/history.html'">üìú View Detailed History</button>

</div>

<script>

// =============== LOAD FROM DB ==================
async function fetchAttempts() {
    const res = await fetch("/api/attempts");
    if (!res.ok) throw new Error("DB API Failed");
    const data = await res.json();
    return data.attempts || [];
}

// =============== MAIN DASHBOARD ================
async function buildDashboard() {
    const div = document.getElementById("analytics");

    let attempts = [];
    try {
        attempts = await fetchAttempts();
    } catch(e) {
        console.error(e);
        div.innerHTML = "<p>‚ö†Ô∏è Unable to load analytics (database error)</p>";
        return;
    }

    if (!attempts.length) {
        div.innerHTML = "<p>No data yet. Take some exams üòä</p>";
        return;
    }

    // ---- GROUP BY QUIZ ----
    const grouped = {};
    attempts.forEach(a => {
        const key = a.quiz_title || "Unknown Quiz";
        if (!grouped[key]) grouped[key] = [];
        grouped[key].push(a);
    });

    let html = "";

    Object.keys(grouped).forEach(key => {
        const list = grouped[key];
        if (!list.length) return;

        // Sort newest ‚Üí oldest
        list.sort((a,b) => (b.completed_at || "").localeCompare(a.completed_at || ""));

        const scores = list.map(a => Number(a.percent || 0));
        const avg = Math.round(scores.reduce((a,b)=>a+b,0) / scores.length);
        const best = Math.max(...scores);
        const passes = list.filter(a => a.percent >= 75).length;
        const passRate = Math.round((passes / list.length) * 100);

        // ===== PERFORMANCE TREND =====
        let trendMsg = "Keep going!";
        let trendClass = "";
        if (list.length >= 2) {
            const last = list[0].percent;
            const prev = list[1].percent;

            if (last > prev) { trendMsg = "üìà Improving ‚Äî Great work!"; trendClass="good"; }
            else if (last < prev) { trendMsg = "üìâ Slight drop ‚Äî review weak spots"; trendClass="bad"; }
            else { trendMsg = "‚û°Ô∏è Holding steady"; trendClass="warn"; }
        }

        // ===== MISSED QUESTIONS =====
        let hasMissed = false;
        list.forEach(a => {
            if (a.missedQuestions && a.missedQuestions.length) hasMissed = true;
        });

        let missedHtml = "";

        if (hasMissed) {
            const latest = list[0];
            const attemptId = latest.attemptId || latest.id;

            const reviewUrl = attemptId
                ? `/review.html?attempt=${attemptId}`
                : `/review.html`;

            // Build dropdown for attempts
            const options = list.map((a, i) => {
                const label = `Attempt ${list.length - i} ‚Äî ${a.percent}% ‚Äî ${a.completed_at || "Unknown Date"}`;
                return `<option value="${a.id || a.attemptId}">${label}</option>`;
            }).join("");

            missedHtml = `
                <button onclick="location.href='${reviewUrl}'">
                    üîç View Most Recent Attempt Review
                </button>

                <br><br>

                <label style="font-weight:bold;">Select Attempt to Review:</label>
                <select id="select-${key.replace(/\\s+/g,'')}">
                    ${options}
                </select>

                <button onclick="reviewSelected('${key.replace(/\\s+/g,'')}')">
                    üìú Review Selected Attempt
                </button>
            `;
        }


        html += `
        <div class="section">

            <h2>üìò ${key}</h2>

            <div class="stat-grid">
                <div class="stat-card">
                    <div>Total Attempts</div>
                    <div class="big">${list.length}</div>
                </div>

                <div class="stat-card">
                    <div>Average Score</div>
                    <div class="big">${avg}%</div>
                </div>

                <div class="stat-card">
                    <div>Best Score</div>
                    <div class="big good">${best}%</div>
                </div>

                <div class="stat-card">
                    <div>Pass Rate</div>
                    <div class="big ${passRate>=75?'good':passRate>=50?'warn':'bad'}">
                        ${passRate}%
                    </div>
                </div>
            </div>

            <div class="section ${trendClass}">
                <h3>üìà Performance Trend</h3>
                <p>${trendMsg}</p>
            </div>

            <div class="section">
                ${missedHtml}
            </div>

        </div>`;
    });

    div.innerHTML = html;
}

function reviewSelected(key) {
    const sel = document.getElementById(`select-${key}`);
    if (!sel) return;

    const id = sel.value;
    if (!id) {
        alert("No attempt selected.");
        return;
    }

    location.href = `/review.html?attempt=${id}`;
}





// ================= RUN ==================
buildDashboard();

</script>

</body>
</html>
