<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Analytics Dashboard</title>
<link rel="stylesheet" href="/style.css">

<style>

.container {
    max-width: 960px;
    margin: auto;
}

.stat-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit,minmax(200px,1fr));
    gap: 14px;
}

.stat-card {
    background: rgba(0,0,0,.75);
    border: 1px solid rgba(255,255,255,.25);
    padding: 12px;
    border-radius: 10px;
    text-align:center;
    box-shadow: 0 0 25px rgba(0,0,0,.9);
}

.big {
    font-size: 30px;
    font-weight: bold;
}

.good { color:#00ff80; }
.warn { color:#ffeb3b; }
.bad  { color:#ff5050; }

.section {
    margin-top:18px;
    padding:12px;
    border-radius:10px;
    background:rgba(0,0,0,.65);
    border:1px solid rgba(255,255,255,.25);
}

.barRow {
    margin:6px 0;
    background:rgba(255,255,255,.1);
    border-radius:6px;
    overflow:hidden;
}

.barFill {
    background:linear-gradient(90deg,#ff4d4d,#ffae00);
    height:18px;
}

.barLabel {
    font-size:13px;
}

</style>
</head>

<body>
<div class="container">

<h1 class="hero-title">
ğŸ“Š Performance & Study Analytics
</h1>

<div id="analytics"></div>

<br>
<button onclick="location.href='/'">ğŸ  Back to Portal</button>
<button onclick="location.href='/history.html'">ğŸ“œ View Detailed History</button>

</div>

<script>
const HISTORY_KEY = "serverplus_history_v2";

/* ---------------------------------------------
   QUIZ NAME REGISTRY (from quizzes.json)
--------------------------------------------- */
let QUIZ_NAME_MAP = {};

// Load quiz registry FIRST
fetch('/config/quizzes.json')
    .then(r => r.json())
    .then(list => {
        list.forEach(q => {
    if (!q.title || !q.html) return;

    // Example: quiz_1767557688.html
    const htmlName = q.html;
    const baseName = htmlName.replace(".html","");     // quiz_1767557688
    const jsonName = baseName + ".json";               // quiz_1767557688.json

    // Support ALL possible history keys
    QUIZ_NAME_MAP[htmlName]          = q.title;
    QUIZ_NAME_MAP["/data/" + htmlName] = q.title;

    QUIZ_NAME_MAP[jsonName]          = q.title;
    QUIZ_NAME_MAP["/data/" + jsonName] = q.title;
});

        buildDashboard();
    })
    .catch(() => {
        console.warn("Could not load quizzes.json â€” fallback names only");
        buildDashboard();
    });


/* ---------------------------------------------
   SMART HISTORY LOADER (supports legacy)
--------------------------------------------- */
function loadHistory() {
    let v2 = JSON.parse(localStorage.getItem(HISTORY_KEY) || "{}");

    if (Object.keys(v2).length)
        return v2;

    let legacy = JSON.parse(localStorage.getItem("history") || "[]");

    if (legacy.length) {
        let grouped = {};
        legacy.forEach(entry => {
            const key = entry.quiz || "Unknown Quiz";
            if (!grouped[key]) grouped[key] = [];
            grouped[key].push(entry);
        });

        localStorage.setItem(HISTORY_KEY, JSON.stringify(grouped));
        return grouped;
    }

    return {};
}


/* ---------------------------------------------
   DASHBOARD BUILDER
--------------------------------------------- */
function buildDashboard() {
    const div = document.getElementById("analytics");
    const store = loadHistory();
    const quizKeys = Object.keys(store);

    if (!quizKeys.length) {
        div.innerHTML = "<p>No data yet. Take some exams ğŸ˜Š</p>";
        return;
    }

    let html = "";

    quizKeys.forEach(key => {
        const attempts = store[key];
        if (!attempts || !attempts.length) return;

        const scores = attempts.map(a => a.percent);
        const avg = Math.round(scores.reduce((a,b)=>a+b,0) / scores.length);
        const best = Math.max(...scores);
        const passes = attempts.filter(a=>a.percent>=75).length;
        const passRate = Math.round((passes / attempts.length) * 100);

        // ---- Performance Trend ----
        let trendMsg = "Keep going!";
        let trendClass = "";
        if (attempts.length >= 2) {
            const last = attempts[attempts.length-1].percent;
            const prev = attempts[attempts.length-2].percent;
            if (last > prev) { trendMsg = "ğŸ“ˆ Improving â€” Great work!"; trendClass="good"; }
            else if (last < prev) { trendMsg = "ğŸ“‰ Slight drop â€” Review missed topics"; trendClass="bad"; }
            else { trendMsg = "â¡ï¸ Holding steady"; trendClass="warn"; }
        }

        // ---- Most Missed Questions ----
        let missedMap = {};
        attempts.forEach(a=>{
            if (!a.missed) return;
            a.missed.forEach(m=>{
                missedMap[m] = (missedMap[m]||0)+1;
            });
        });

        let missedHtml = "<p>No problem questions yet ğŸ‰</p>";
        const missedKeys = Object.keys(missedMap);

        if (missedKeys.length) {
            missedHtml = missedKeys
                .sort((a,b)=>missedMap[b]-missedMap[a])
                .map(q=>`
                <div class="barRow">
                    <div class="barFill" style="width:${Math.min(missedMap[q]*20,100)}%"></div>
                </div>
                <div class="barLabel">Question ${q} â€” ${missedMap[q]} misses</div>
                `).join("");
        }

        html += `
        <div class="section">

            <!-- Show friendly quiz name when possible -->
            <h2>ğŸ“˜ ${
                (attempts[0]?.quizName ||     // if future stored name
                 attempts[0]?.quiz ||         // if stored quiz label
                 QUIZ_NAME_MAP[key] ||        // from quizzes.json (NOW WORKING ğŸ‰)
                 key.replace("/data/",""))     // fallback filename
            }</h2>

            <div class="stat-grid">
                <div class="stat-card">
                    <div>Total Attempts</div>
                    <div class="big">${attempts.length}</div>
                </div>

                <div class="stat-card">
                    <div>Average Score</div>
                    <div class="big">${avg}%</div>
                </div>

                <div class="stat-card">
                    <div>Best Score</div>
                    <div class="big good">${best}%</div>
                </div>

                <div class="stat-card">
                    <div>Pass Rate</div>
                    <div class="big ${passRate>=75?'good':passRate>=50?'warn':'bad'}">
                        ${passRate}%
                    </div>
                </div>
            </div>

            <div class="section ${trendClass}">
                <h3>ğŸ“ˆ Performance Trend</h3>
                <p>${trendMsg}</p>
            </div>

            <div class="section">
                <h3>ğŸ”¥ Most Missed Questions</h3>
                ${missedHtml}
            </div>
        </div>
        `;
    });

    div.innerHTML = html;
}
</script>

</body>
</html>
