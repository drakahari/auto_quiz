<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Analytics Dashboard</title>
<link rel="stylesheet" href="/style.css">

<style>

.container {
    max-width: 960px;
    margin: auto;
}

.stat-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit,minmax(200px,1fr));
    gap: 14px;
}

.stat-card {
    background: rgba(0,0,0,.75);
    border: 1px solid rgba(255,255,255,.25);
    padding: 12px;
    border-radius: 10px;
    text-align:center;
    box-shadow: 0 0 25px rgba(0,0,0,.9);
}

.big {
    font-size: 30px;
    font-weight: bold;
}

.good { color:#00ff80; }
.warn { color:#ffeb3b; }
.bad  { color:#ff5050; }

.section {
    margin-top:18px;
    padding:12px;
    border-radius:10px;
    background:rgba(0,0,0,.65);
    border:1px solid rgba(255,255,255,.25);
}

.barRow {
    margin:6px 0;
    background:rgba(255,255,255,.1);
    border-radius:6px;
    overflow:hidden;
}

.barFill {
    background:linear-gradient(90deg,#ff4d4d,#ffae00);
    height:18px;
}

.barLabel {
    font-size:13px;
}

</style>
</head>

<body>
<div class="container">

<h1 class="hero-title">
ğŸ“Š Performance & Study Analytics
</h1>

<div id="analytics"></div>

<br>
<button onclick="location.href='/'">ğŸ  Back to Portal</button>
<button onclick="location.href='/history.html'">ğŸ“œ View Detailed History</button>

</div>

<script>
const HISTORY_KEY = "serverplus_history_v2";

function loadHistory() {
    try {
        return JSON.parse(localStorage.getItem(HISTORY_KEY) || "{}");
    } catch {
        return {};
    }
}

function buildDashboard() {
    const div = document.getElementById("analytics");
    const store = loadHistory();
    const quizKeys = Object.keys(store);

    if (!quizKeys.length) {
        div.innerHTML = "<p>No data yet. Take some exams ğŸ˜Š</p>";
        return;
    }

    let attempts = [];
    quizKeys.forEach(k => attempts.push(...store[k]));

    if (!attempts.length) {
        div.innerHTML = "<p>No attempts recorded yet.</p>";
        return;
    }

    const scores = attempts.map(a => a.percent);
    const avg = Math.round(scores.reduce((a,b)=>a+b,0) / scores.length);
    const best = Math.max(...scores);
    const passes = attempts.filter(a=>a.percent>=75).length;
    const passRate = Math.round((passes / attempts.length) * 100);

    let trendMsg = "Keep going!";
    let trendClass = "";
    if (attempts.length >= 2) {
        const last = attempts[attempts.length-1].percent;
        const prev = attempts[attempts.length-2].percent;
        if (last > prev) { trendMsg = "ğŸ“ˆ Improving â€” Great work!"; trendClass="good"; }
        else if (last < prev) { trendMsg = "ğŸ“‰ Slight drop â€” Review missed topics"; trendClass="bad"; }
        else { trendMsg = "â¡ï¸ Holding steady"; trendClass="warn"; }
    }

    let missedMap = {};
    attempts.forEach(a=>{
        if (!a.missed) return;
        a.missed.forEach(m=>{
            missedMap[m] = (missedMap[m]||0)+1;
        });
    });

    let missedHtml = "<p>No common misses yet ğŸ‰</p>";
    const missedKeys = Object.keys(missedMap);
    if (missedKeys.length) {
        missedHtml = missedKeys
            .sort((a,b)=>missedMap[b]-missedMap[a])
            .map(q=>`
            <div class="barRow">
                <div class="barFill" style="width:${Math.min(missedMap[q]*20,100)}%"></div>
            </div>
            <div class="barLabel">Question ${q} â€” ${missedMap[q]} misses</div>
        `).join("");
    }

    const studyCount = attempts.filter(a=>a.mode==="Study").length;
    const examCount = attempts.filter(a=>a.mode==="Exam").length;

    div.innerHTML = `
    <div class="stat-grid">
        <div class="stat-card">
            <div>Total Attempts</div>
            <div class="big">${attempts.length}</div>
        </div>

        <div class="stat-card">
            <div>Average Score</div>
            <div class="big">${avg}%</div>
        </div>

        <div class="stat-card">
            <div>Best Score</div>
            <div class="big good">${best}%</div>
        </div>

        <div class="stat-card">
            <div>Pass Rate</div>
            <div class="big ${passRate>=75?'good':passRate>=50?'warn':'bad'}">
                ${passRate}%
            </div>
        </div>
    </div>

    <div class="section ${trendClass}">
        <h2>ğŸ“ˆ Performance Trend</h2>
        <p>${trendMsg}</p>
    </div>

    <div class="section">
        <h2>ğŸ”¥ Most Missed Questions</h2>
        ${missedHtml}
    </div>

    <div class="section">
        <h2>ğŸ§ª Mode Usage</h2>
        Study Mode: <b>${studyCount}</b><br>
        Exam Mode: <b>${examCount}</b>
    </div>
    `;
}

buildDashboard();
</script>

</body>
</html>
